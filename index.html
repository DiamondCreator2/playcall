<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Play Call Live</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            padding-top: 64px; /* Space for fixed header */
        }
        .admin-input {
            @apply border border-gray-300 rounded-md p-1 w-full text-sm focus:ring-blue-500 focus:border-blue-500;
        }
		.nav-link {
            transition: color 0.15s, background-color 0.15s;
        }
        /* Message Box Overlay */
        .message-box-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .message-box-content {
            background-color: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            text-align: center;
        }
        
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <!-- Custom Message Box Modal -->
    <div id="message-box-container" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center transition-opacity duration-300">
        <div class="bg-white rounded-lg shadow-2xl p-6 max-w-sm w-full">
            <h3 id="message-box-title" class="text-xl font-bold mb-4 text-gray-800">Title</h3>
            <p id="message-box-body" class="text-gray-600 mb-6">Body</p>
            <div class="flex justify-end">
                <button id="message-box-ok" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition duration-150">
                    OK
                </button>
            </div>
        </div>
    </div>
    
    <!-- Header: Navigation and Logo -->
    <header class="fixed top-0 left-0 w-full bg-gray-900 text-white shadow-xl z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-auto">
            
            <div class="flex items-center justify-between h-16">
                
                <!-- 1. LEFT SIDE GROUP: Title/Logo + Desktop Links -->
                <div class="flex items-center space-x-6">
                    
                    <!-- Title/Logo -->
                    <div class="flex items-center flex-shrink-0">
                        <span class="text-3xl sm:text-4xl font-black tracking-tight text-white">
                            Play Call
                        </span>
                        
                        <span class="
                            ml-3 
                            bg-red-600 
                            text-white 
                            text-xs 
                            font-extrabold 
                            px-2.5 
                            py-1 
                            rounded-lg 
                            uppercase 
                            tracking-widest 
                            shadow-lg 
                            shadow-red-800/50 
                            self-center 
                            transform 
                            scale-95 
                            hover:scale-100 
                            transition duration-150
                            cursor-default
                        ">
                            Live
                        </span>
                    </div>
                    
                    <!-- Desktop Navigation -->
                    <nav id="desktop-nav" class="hidden sm:flex space-x-4">
                        <a href="#" id="dashboard-link" class="text-red-400 hover:text-red-200 transition duration-150 ease-in-out font-semibold">
                            Dashboard
                        </a>
                        <a href="#" id="scores-link" class="text-white hover:text-red-200 transition duration-150 ease-in-out font-semibold">
                            Live Scores
                        </a>
                        <a href="#" id="admin-link" class="text-white hover:text-red-200 transition duration-150 ease-in-out font-semibold">
                            Admin Panel
                        </a>
                    </nav>

                </div>


                <!-- 2. RIGHT SIDE: Mobile Menu Button -->
                <div class="flex items-center space-x-4">
                    
                    <!-- Mobile Menu Button -->
                    <button id="mobile-menu-button" class="sm:hidden p-2 rounded-md hover:bg-gray-700 transition duration-150">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- 3. Mobile Menu Content (Vertical Links, hidden by default) -->
            <!-- FIX: Added bg-gray-900 and z-50 to ensure menu is on top and has a solid background -->
            <div id="mobile-menu" class="hidden pb-4 sm:hidden bg-gray-900 z-50">
                <a href="#" id="dashboard-link-mobile" class="block py-2 px-3 rounded-md text-base font-medium text-red-400 hover:bg-gray-700 hover:text-red-400 transition duration-150">Dashboard</a>
    		<a href="#" id="scores-link-mobile" class="block py-2 px-3 rounded-md text-base font-medium text-white hover:bg-gray-700 hover:text-red-400 transition duration-150">Live Scores</a>
    		<a href="#" id="admin-link-mobile" class="block py-2 px-3 rounded-md text-base font-medium text-white hover:bg-gray-700 hover:text-red-400 transition duration-150">Admin Panel</a>
            </div>
        </div>
    </header>
   

    <!-- Main Content Area -->
    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        
        <!-- Dashboard View (Followed Games) -->
        <div id="dashboard-view" class="px-4 py-4 sm:px-0">
            <h2 class="text-3xl font-extrabold text-gray-900 mb-6">Your Dashboard</h2>
            <!-- Friend Activity Section (Mock) -->
            <div>
                <h3 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Friend Activity (Mock)</h3>
                <div id="friend-activity-list">
                    <!-- Friend activity list will be injected here -->
                </div>
            </div><br><br>
            <!-- Followed Games Section (Firestore Data) -->
            <div class="mb-10">
                <h3 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Followed Games</h3>
                <div id="no-followed-games" class="p-6 text-center text-gray-500 bg-white rounded-xl shadow-lg border-2 border-dashed border-gray-300">
                    You aren't following any games yet. Head over to the Live Game Feed to start tracking!
                </div>
                <div id="followed-games-container" class="flex flex-wrap gap-4 overflow-x-auto pb-4">
                    <!-- Followed game cards will be injected here -->
                </div>
            </div>

            
        </div>

        <!-- Scores View (Game Feed) -->
        <div id="scores-view" class="hidden space-y-6">
            <h2 class="text-3xl font-bold text-gray-800">Live Game Feed</h2>
            
            <!-- Filter Bar -->
            <div class="flex flex-col sm:flex-row items-start sm:items-center space-y-3 sm:space-y-0 sm:space-x-4 p-4 bg-white rounded-xl shadow-lg">
                <label for="league-filter" class="font-semibold text-gray-700">League:</label>
                <select id="league-filter" class="border border-gray-300 rounded-lg p-2 focus:ring-red-500 focus:border-red-500">
                    <!-- Options will be populated by JS -->
                </select>
                <label for="status-filter" class="font-semibold text-gray-700">Status:</label>
                <select id="status-filter" class="border border-gray-300 rounded-lg p-2 focus:ring-red-500 focus:border-red-500">
                    <option value="All">All</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Scheduled">Scheduled</option>
                    <option value="Final">Final</option>
                </select>
                <input type="text" id="team-search" placeholder="Search team name..." class="flex-grow border border-gray-300 rounded-lg p-2 focus:ring-red-500 focus:border-red-500 sm:ml-auto">
            </div>

            <div id="scores-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Game cards will be inserted here -->
            </div>
        </div>

        <!-- Detail View (Single Game) -->
        <div id="detail-view" class="hidden px-4 py-4 sm:px-0">
            <button id="back-to-scores" class="flex items-center text-red-600 hover:text-red-700 mb-6 font-semibold">
                <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                Back to Feed
            </button>
            <div id="detail-content" class="bg-white p-8 rounded-xl shadow-2xl">
                <!-- Game details and chat mock injected here -->
            </div>
        </div>

        <!-- Admin Panel View -->
        <div id="admin-view" class="hidden px-4 py-4 sm:px-0">
            <h2 class="text-3xl font-extrabold text-gray-900 mb-6">Admin Panel (Read-Only API Data)</h2>
            
            <!-- NEW: Live Prompt Control Panel -->
            <div class="bg-white p-6 rounded-xl shadow-lg mb-8 border-t-4 border-red-600">
                <h3 class="text-2xl font-bold text-gray-800 mb-4">Create New Live Prompt (Yes/No)</h3>
                <p class="text-sm text-gray-600 mb-4">Create a new real-time Yes/No question for a specific game. Only one prompt can be active per game.</p>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <!-- Game ID Input -->
                    <div class="md:col-span-1">
                        <label for="prompt-game-id" class="block text-sm font-medium text-gray-700">Game ID (e.g., NFL-12345)</label>
                        <input type="text" id="prompt-game-id" placeholder="NFL-12345" class="admin-input mt-1">
                    </div>
                    
                    <!-- Prompt Input -->
                    <div class="md:col-span-2">
                        <label for="prompt-question" class="block text-sm font-medium text-gray-700">Question (Yes/No Prompt)</label>
                        <input type="text" id="prompt-question" placeholder="Will the next play be a pass?" class="admin-input mt-1">
                    </div>
                    
                    <!-- Create Prompt Button -->
                    <div class="md:col-span-1">
                        <button id="prompt-send-btn" class="w-full bg-red-600 text-white font-semibold py-2 rounded-lg hover:bg-red-700 transition duration-150 shadow-md">
                            Create Live Prompt
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- NEW: Active & Resolved Prompts List -->
            <div class="bg-white p-6 rounded-xl shadow-lg mt-8">
                <h3 class="text-2xl font-bold text-gray-800 mb-4">Active & Resolved Prompts</h3>
                <p class="text-sm text-gray-600 mb-4">Set the final answer here. Resolving a prompt will expire it for viewers.</p>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Game ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Question</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Answer</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="admin-prompt-list" class="bg-white divide-y divide-gray-200">
                            <!-- Prompt rows injected here -->
                        </tbody>
                    </table>
                    <p id="no-prompts-message" class="text-center text-gray-500 py-4 hidden">No active or recently resolved prompts found.</p>
                </div>
            </div>
            
            <!-- Existing Game List -->
            <div class="bg-white p-6 rounded-xl shadow-lg overflow-x-auto mt-8">
                <h3 class="text-2xl font-bold text-gray-800 mb-4">Live Game Scoreboard (Read-Only)</h3>
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">League</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Teams</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Score H/A (R/O)</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="admin-game-list" class="bg-white divide-y divide-gray-200">
                        <!-- Game rows injected here -->
                    </tbody>
                </table>
            </div>
        </div>

    </main>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // UPDATED IMPORTS: Added query, where, updateDoc, addDoc, getDocs for prompt system
        import { getFirestore, doc, setDoc, onSnapshot, collection, increment, writeBatch, FieldValue, query, where, updateDoc, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Use Debug logging for better visibility in the console
        setLogLevel('Debug');

        // --- GLOBAL FIREBASE/APP VARS ---
        
        // ====================================================================================
        // IMPORTANT: USER-PROVIDED FALLBACK CONFIGURATION
        // If you are running this code outside of the Canvas environment, you MUST 
        // replace the placeholder values below with your actual Firebase project credentials.
        // Also, ensure the 'Anonymous' sign-in provider is enabled in your project settings.
        // ====================================================================================
        const USER_FIREBASE_CONFIG = {
            apiKey: "AIzaSyCsunmtOlyDZHxzVBOkvQsduSyg4MU50LA", // <-- REPLACE THIS
            authDomain: "playcallbackend.firebaseapp.com", // <-- REPLACE THIS
            projectId: "playcallbackend", // <-- REPLACE THIS
            storageBucket: "playcallbackend.firebasestorage.app",
            messagingSenderId: "977048745219",
            appId: "1:977048745219:web:39669929d446eddaab6536",
            measurementId: "G-YXELM1JJSH"
        };
        // ====================================================================================

        // The application ID used for Firestore paths (artifacts/{appId}/...)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Use the Canvas-provided config if available, otherwise fall back to the user-provided config
        let resolvedFirebaseConfig;
        try {
            const environmentConfig = typeof __firebase_config !== 'undefined' && __firebase_config ? JSON.parse(__firebase_config) : {};
            // If the environment config has a projectId, use it; otherwise, use the user's config
            if (environmentConfig.projectId) {
                resolvedFirebaseConfig = environmentConfig;
            } else {
                resolvedFirebaseConfig = USER_FIREBASE_CONFIG;
            }
        } catch (e) {
            console.error("Failed to parse environment config, falling back to USER_FIREBASE_CONFIG.", e);
            resolvedFirebaseConfig = USER_FIREBASE_CONFIG;
        }

        // A simple check to ensure the user has updated the configuration outside of Canvas
        if (!resolvedFirebaseConfig.projectId || resolvedFirebaseConfig.projectId.includes("YOUR_PROJECT_ID")) {
            console.warn("⚠️ Firebase Warning: Running with dummy configuration. Please update the 'USER_FIREBASE_CONFIG' object with your actual Firebase project credentials to run externally.");
        }


        let app, db, auth;
        let userId = null; // Will be set after auth
        let isAuthReady = false; // Flag to indicate auth state is resolved

        // --- GLOBAL DATA & STATE ---
        let gamesData = []; 
        let followedGames = {}; // PRIVATE: User's list of followed games
        let gameMetadata = {}; // PUBLIC: Real-time follower counts for all games (New)
        let fetchErrorCount = 0;
        let unsubscribePromptListener = null; // RENAMED: Global state for listener cleanup (used for Detail View prompt)
        let unsubscribePromptsAdmin = null; // NEW: Global state for Admin Prompts listener

        // Mock data for the Friend Activity Feed
        const mockFriends = [
            { name: 'Alex M.', status: 'Watching', detail: 'NFL (DAL vs PHI)', color: 'green' },
            { name: 'Jamie P.', status: 'Offline', detail: '', color: 'gray' },
            { name: 'Chris K.', status: 'Watching', detail: 'EPL (MAN U vs LIV)', color: 'green' },
            { name: 'Morgan S.', status: 'Browsing', detail: 'Scores', color: 'blue' },
        ];


        // --- ESPN API ENDPOINT CONFIGURATION ---
        // Base URLs only, date will be appended for historical data
        const ESPN_ENDPOINTS = {
            'NFL': 'https://site.api.espn.com/apis/site/v2/sports/football/nfl/scoreboard',
            'NCAAF': 'https://site.api.espn.com/apis/site/v2/sports/football/college-football/scoreboard',
            'NBA': 'https://site.api.espn.com/apis/site/v2/sports/basketball/nba/scoreboard',
            'MLB': 'https://site.api.espn.com/apis/site/v2/sports/baseball/mlb/scoreboard',
            'EPL': 'https://site.api.espn.com/apis/site/v2/sports/soccer/eng.1/scoreboard',
            'NHL': 'https://site.api.espn.com/apis/site/v2/sports/hockey/nhl/scoreboard',
        };

        // --- Custom Message Box (Replacing alert/confirm) ---

        /**
         * Shows a custom modal message box.
         * @param {string} title - The title of the message box.
         * @param {string} body - The main body text.
         */
        function showMessageBox(title, body) {
            document.getElementById('message-box-title').textContent = title;
            document.getElementById('message-box-body').textContent = body;
            const container = document.getElementById('message-box-container');
            container.classList.remove('hidden');

            const okButton = document.getElementById('message-box-ok');
            // Clone the button to remove old listeners and add a fresh one
            const newOkButton = okButton.cloneNode(true);
            okButton.parentNode.replaceChild(newOkButton, okButton);

            newOkButton.addEventListener('click', () => {
                container.classList.add('hidden');
            });
        }
        
        // --- Firestore Path Helper Functions ---
        
        /**
         * Determines the correct Firestore document reference for followed games (PRIVATE).
         */
        function getFollowedGamesDocRef(dbInstance, currentUserId) {
            if (!dbInstance || !currentUserId) return null;

            if (appId === 'default-app-id') {
                return doc(dbInstance, 'users', currentUserId, 'followed_games', 'user_follows');
            } else {
                return doc(dbInstance, 'artifacts', appId, 'users', currentUserId, 'followed_games', 'user_follows');
            }
        }
        
        /**
         * Determines the correct Firestore document reference for game metadata (PUBLIC).
         * This uses the public data path.
         */
        function getGameMetadataColRef(dbInstance) {
            if (!dbInstance) return null;

            if (appId === 'default-app-id') {
                return collection(dbInstance, 'game_metadata');
            } else {
                return collection(dbInstance, 'artifacts', appId, 'public', 'data', 'game_metadata');
            }
        }
        
        /**
         * NEW: Determines the correct Firestore collection reference for game prompts (PUBLIC).
         */
        function getGamePromptsColRef(dbInstance) {
            if (!dbInstance) return null;

            if (appId === 'default-app-id') {
                return collection(dbInstance, 'game_prompts');
            } else {
                return collection(dbInstance, 'artifacts', appId, 'public', 'data', 'game_prompts');
            }
        }


        // --- Date Helper Functions ---

        /**
         * Returns a date string in YYYYMMDD format for ESPN API.
         * @param {number} daysAgo - Number of days in the past (0 for today, 1 for yesterday, etc.)
         * @returns {string} The formatted date string.
         */
        function getApiDate(daysAgo) {
            const date = new Date();
            date.setDate(date.getDate() - daysAgo);
            
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            
            return `${year}${month}${day}`;
        }


        // --- API Data Fetching & Transformation ---

        /**
         * Transforms raw ESPN event data for a single game into the application's gamesData format.
         */
        function transformEspnGame(league, event) {
            if (!event.competitions || event.competitions.length === 0) return null;

            const competition = event.competitions[0];
            const competitors = competition.competitors;

            if (!competitors || competitors.length < 2) return null;

            const home = competitors.find(c => c.homeAway === 'home');
            const away = competitors.find(c => c.homeAway === 'away');

            if (!home || !away) return null;

            // Determine status and time
            let statusText = event.status.type.detail || event.status.type.shortDetail || 'Scheduled';
            const statusName = event.status.type.name;
            let displayTime = '';
            let gameStatus = 'Scheduled';

            if (statusName === 'STATUS_FINAL' || statusName === 'STATUS_POSTPONED' || statusName === 'STATUS_CANCELLED') {
                gameStatus = 'Final';
            } else if (statusName === 'STATUS_IN_PROGRESS' || statusName === 'STATUS_HALFTIME' || statusName === 'STATUS_DELAYED') {
                gameStatus = 'In Progress';
            } else {
                gameStatus = 'Scheduled';
            }

            // Refine display time based on sport/status
            if (gameStatus === 'In Progress') {
                const period = event.status.period || 0;
                const clock = event.status.displayClock || '0:00';
                
                if (league === 'NHL') { 
                    displayTime = `P${period} - ${clock}`;
                } 
                else if (league === 'NFL' || league === 'NCAAF' || league === 'NBA') { 
                    displayTime = `Q${period} - ${clock}`;
                } else if (league === 'EPL') {
                    // Soccer uses minutes
                    displayTime = `${period}'`;
                } else if (league === 'MLB') {
                    displayTime = `Inning ${period}`;
                }
            } else if (gameStatus === 'Final') {
                // For final games, use the date instead of the time
                const date = new Date(event.date);
                displayTime = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                statusText = statusText.includes('Final') ? 'Final' : statusText;
            } else {
                // Scheduled
                const date = new Date(event.date);
                displayTime = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                statusText = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }

            // Use competition.id if available, otherwise fallback to event.id, and prefix with league for uniqueness across days
            const uniqueId = competition.id || event.id;
            
            return {
                id: `${league}-${uniqueId}`, 
                league: league,
                status: gameStatus, // Simplified status for filtering
                time: displayTime,
                homeTeam: home.team.shortDisplayName || home.team.displayName || home.team.abbreviation || 'Home',
                homeScore: parseInt(home.score) || 0,
                awayTeam: away.team.shortDisplayName || away.team.displayName || away.team.abbreviation || 'Away',
                awayScore: parseInt(away.score) || 0,
                // Followers count is now pulled from the gameMetadata object on render
                followers: 0, 
                statusDetail: statusText,
            };
        }
        
        /**
         * Handles exponential backoff logic for retries.
         */
        async function withExponentialBackoff(fn, maxRetries = 5, delay = 1000) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await fn();
                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw error; 
                    }
                    const currentDelay = delay * Math.pow(2, i);
                    await new Promise(resolve => setTimeout(resolve, currentDelay));
                }
            }
        }

        /**
         * Fetches scores for all configured leagues from the ESPN API endpoints, 
         * including today, yesterday, and the day before.
         */
        async function fetchEspnScores() {
            let allGames = [];
            const datesToFetch = [
                { daysAgo: 0, label: 'Today' },
                { daysAgo: 1, label: 'Yesterday' },
                { daysAgo: 2, label: '2 Days Ago' }
            ];
            
            for (const dateConfig of datesToFetch) {
                const apiDate = getApiDate(dateConfig.daysAgo);
                
                for (const [league, baseUrl] of Object.entries(ESPN_ENDPOINTS)) {
                    const url = dateConfig.daysAgo > 0 
                        ? `${baseUrl}?dates=${apiDate}`
                        : baseUrl;

                    try {
                        await withExponentialBackoff(async () => {
                            const response = await fetch(url);
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status} for ${league} on ${dateConfig.label}`);
                            }
                            const data = await response.json();

                            if (data.events && Array.isArray(data.events)) {
                                const leagueGames = data.events
                                    .map(event => transformEspnGame(league, event))
                                    .filter(game => game !== null);
                                
                                if (dateConfig.daysAgo > 0) {
                                    const finalGames = leagueGames.filter(g => g.status === 'Final');
                                    allGames.push(...finalGames);
                                } else {
                                    allGames.push(...leagueGames);
                                }
                            }
                        });
                    } catch (error) {
                        console.error(`Error fetching or processing ${league} data for ${dateConfig.label}:`, error);
                        fetchErrorCount++;
                        if (fetchErrorCount >= 10) {
                             showMessageBox("Critical Fetch Error", "Failed to load scores after multiple retries across dates. The API may be unavailable or have changed.");
                        }
                    }
                }
            }
            
            const uniqueGames = Array.from(new Map(allGames.map(game => [game.id, game])).values());
            
            fetchErrorCount = 0;
            gamesData = uniqueGames;

            // Re-render the relevant views (triggered after data is fetched)
            renderFollowedGames();
            renderScores();
            renderAdminPanel();
        }


        // --- UI Rendering Functions ---

        /**
         * Renders a game card for the Live Game Feed view (scores-view).
         */
        function renderGameCardFeed(game, isFollowed) {
            
            let borderColorClass = '';
            let statusText = game.status.toUpperCase();
            let statusColor = '';

            if (game.status === 'In Progress') {
                borderColorClass = 'border-red-500';
                statusText = 'LIVE';
                statusColor = 'text-green-600';
            } else if (game.status === 'Final') {
                borderColorClass = 'border-blue-500';
                statusColor = 'text-gray-500';
            } else {
                // Scheduled
                borderColorClass = 'border-gray-400';
                statusColor = 'text-blue-600';
            }
            
            // --- LOGIC: Determine winning score class for red highlight ---
            let awayScoreClass = 'text-gray-700';
            let homeScoreClass = 'text-gray-700';

            if (game.status !== 'Scheduled') {
                if (game.awayScore > game.homeScore) {
                    awayScoreClass = 'text-red-600';
                } else if (game.homeScore > game.awayScore) {
                    homeScoreClass = 'text-red-600';
                }
                // If tied, both remain 'text-gray-700'
            }
            // --- END LOGIC ---

            const awayScoreDisplay = `<span class="text-3xl font-extrabold ${awayScoreClass}">${game.awayScore}</span>`;

            const homeScoreDisplay = game.status === 'Scheduled' 
                ? `<span class="text-sm font-medium text-gray-500">${game.statusDetail} @ ${game.time}</span>` 
                : `<span class="text-3xl font-extrabold ${homeScoreClass}">${game.homeScore}</span>`;


            const followButton = `<button data-game-id="${game.id}" data-action="${isFollowed ? 'unfollow' : 'follow'}" class="follow-btn text-xs font-semibold px-3 py-1 rounded-full ${isFollowed ? 'bg-red-500 text-white hover:bg-red-600' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'} transition duration-150">
                    ${isFollowed ? 'Following' : 'Follow'}
                </button>`;

            const detailLink = `<a href="#" data-game-id="${game.id}" class="detail-link text-blue-600 hover:text-blue-800 text-sm font-medium mt-2 block">View Details & Chat</a>`;

            // --- USE REAL-TIME PUBLIC FOLLOWER COUNT ---
            const followerCount = gameMetadata[game.id]?.followerCount || 0;
            
            return `
                <div class="game-card bg-white p-6 rounded-xl shadow-lg border-t-4 ${borderColorClass} hover:shadow-2xl transition duration-300">
                    <div class="flex justify-between items-start mb-4">
                        <span class="text-xs font-medium text-gray-500 bg-gray-100 px-3 py-1 rounded-full">${game.league}</span>
                        ${followButton}
                    </div>

                    <div class="space-y-4">
                        <!-- Away Team -->
                        <div class="flex justify-between items-center border-b pb-2">
                            <div class="flex items-center space-x-3">
                                <span class="text-lg font-bold text-gray-800">${game.awayTeam}</span>
                            </div>
                            ${awayScoreDisplay} <!-- Score uses conditional class -->
                        </div>

                        <!-- Home Team -->
                        <div class="flex justify-between items-center">
                            <div class="flex items-center space-x-3">
                                <span class="text-lg font-bold text-gray-800">${game.homeTeam}</span>
                                
                            </div>
                            ${homeScoreDisplay} <!-- Score/Time uses conditional class -->
                        </div>
                    </div>

                    <div class="mt-4 pt-4 border-t border-gray-100 flex justify-between items-center">
                        <span class="text-sm font-medium ${statusColor}">
                            ${statusText}
                            ${game.status !== 'Scheduled' && game.status !== 'Final' ? ' (' + game.time + ')' : ''}
                            ${game.status === 'Final' ? ' (' + game.time + ')' : ''}
                        </span>
                        <div class="text-xs text-gray-500 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 text-red-500" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.98 5.98 0 0010 16a5.979 5.979 0 004.546-2.084A5 5 0 0010 11z" clip-rule="evenodd" />
                            </svg>
                            ${followerCount} Following
                        </div>
                    </div>
                    ${detailLink}
                </div>
            `;
        }
        
        /**
         * Renders a simplified game card specifically for the Followed Games (Dashboard) view.
         */
        function renderFollowedGameCardDashboard(game) {
            
            // --- NEW LOGIC FOR STATUS COLOR-CODING ---
            let borderColorClass = 'border-red-500'; // Default to LIVE red
            let statusTextColor = 'text-red-600'; // Default to LIVE red
            let statusText = 'LIVE';

            if (game.status === 'Final') {
                borderColorClass = 'border-blue-500';
                statusTextColor = 'text-blue-600';
                statusText = 'FINAL';
            } else if (game.status === 'Scheduled') {
                borderColorClass = 'border-gray-400';
                statusTextColor = 'text-gray-600';
                statusText = 'UPCOMING'; // Changed Scheduled to Upcoming for better visual cue
            }
            
            const fullStatusText = game.status === 'In Progress' ? `LIVE (${game.time})` : statusText;

            // Determine which score is higher (winning team gets red text)
            let awayScoreClass = 'text-gray-900';
            let homeScoreClass = 'text-gray-900';
            
            if (game.status !== 'Scheduled') {
                if (game.awayScore > game.homeScore) {
                    awayScoreClass = 'text-red-600';
                } else if (game.homeScore > game.awayScore) {
                    homeScoreClass = 'text-red-600';
                }
            }
            // --- END NEW LOGIC ---
            
            let descriptionText = game.status === 'Scheduled' ? `${game.statusDetail} @ ${game.time}` : game.statusDetail;
            if (game.status === 'Final') {
                descriptionText = `Final (${game.time})`; // Added the date for Final games
            }

            // --- USE REAL-TIME PUBLIC FOLLOWER COUNT ---
            const followerCount = gameMetadata[game.id]?.followerCount || 0;

            return `
                <div class="bg-white p-6 rounded-xl shadow-md border-l-4 ${borderColorClass} flex flex-col justify-between w-full sm:w-80 flex-shrink-0 hover:shadow-xl transition duration-150">
                    
                    <!-- Clickable Body for Detail View -->
                    <div class="cursor-pointer dashboard-detail-link hover:bg-gray-50 p-2 -m-2 rounded-lg" data-game-id="${game.id}">
                        <!-- Header: League and Status -->
                        <div class="flex items-center mb-2">
                            <span class="text-xs font-extrabold tracking-wider uppercase ${statusTextColor}">${game.league} - ${fullStatusText}</span>
                        </div>

                        <!-- Scores and Teams (Bold, Large Text) -->
                        <div class="text-xl font-extrabold">
                            <p class="mb-1">
                                <span class="${awayScoreClass}">${game.awayTeam} ${game.awayScore}</span> vs. 
                                <span class="${homeScoreClass}">${game.homeScore} ${game.homeTeam}</span>
                            </p>
                        </div>

                        <!-- Time, Follower Count -->
                        <div class="flex flex-col mt-2">
                            <span class="text-sm font-medium text-gray-500">${descriptionText}</span>
                            <div class="text-xs text-gray-500 flex items-center mt-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 text-red-500" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.98 5.98 0 0010 16a5.979 5.979 0 004.546-2.084A5 5 0 0010 11z" clip-rule="evenodd" />
                                </svg>
                                ${followerCount} Following
                            </div>
                        </div>
                    </div>

                    <!-- Unfollow Button (Outside clickable detail area) -->
                    <div class="flex justify-end pt-3 border-t border-gray-100 mt-2">
                        <button data-game-id="${game.id}" data-action="unfollow" class="follow-btn text-xs font-semibold px-3 py-1 rounded-full border border-gray-300 text-gray-700 hover:bg-gray-100 transition duration-150">
                            Unfollow
                        </button>
                    </div>
                </div>
            `;
        }

        /**
         * Renders the mock friend activity feed.
         */
        function renderFriendActivityFeed() {
            const container = document.getElementById('friend-activity-list');
            
            const activityListHtml = mockFriends.map(friend => {
                const dotColor = friend.color === 'green' ? 'bg-green-500' : friend.color === 'blue' ? 'bg-blue-500' : 'bg-gray-400';
                
                let detailLink;
                if (friend.status === 'Watching') {
                    detailLink = `<span class="text-xs font-semibold text-red-600">${friend.status} ${friend.detail}</span>`;
                } else if (friend.status === 'Browsing') {
                    detailLink = `<span class="text-xs font-semibold text-blue-600">${friend.status} ${friend.detail}</span>`;
                } else {
                    detailLink = `<span class="text-xs font-semibold text-gray-500">Offline</span>`;
                }

                return `
                    <div class="flex justify-between items-center py-3 border-b border-gray-100 last:border-b-0">
                        <div class="flex items-center space-x-3">
                            <span class="w-2 h-2 rounded-full ${dotColor}"></span>
                            <span class="text-base font-black text-gray-800">${friend.name}</span>
                        </div>
                        ${detailLink}
                    </div>
                `;
            }).join('');

            const html = `
                <div class="bg-white p-6 rounded-xl shadow-xl">
                    ${activityListHtml}
                </div>
            `;

            container.innerHTML = html;
        }


        function renderScores() {
            // Only render if Firestore is ready
            if (!isAuthReady) return; 

            const container = document.getElementById('scores-container');
            const filterLeague = document.getElementById('league-filter').value;
            const filterStatus = document.getElementById('status-filter').value;
            const searchQuery = document.getElementById('team-search').value.toLowerCase(); 

            let filteredGames = gamesData.filter(game => {
                const leagueMatch = filterLeague === 'All' || game.league === filterLeague;
                const statusMatch = filterStatus === 'All' || game.status === filterStatus;
                
                const searchMatch = !searchQuery || 
                                    game.homeTeam.toLowerCase().includes(searchQuery) ||
                                    game.awayTeam.toLowerCase().includes(searchQuery);

                return leagueMatch && statusMatch && searchMatch;
            });

            // --- START: Sorting Logic for Status (Live > Scheduled > Final) ---
            const statusOrder = {
                'In Progress': 1,
                'Scheduled': 2, 
                'Final': 3      
            };

            filteredGames.sort((a, b) => {
                const orderA = statusOrder[a.status] || 99;
                const orderB = statusOrder[b.status] || 99;

                // 1. Sort by status priority (1=Live, 2=Scheduled, 3=Final)
                if (orderA !== orderB) {
                    return orderA - orderB;
                }

                // 2. Secondary sort: Alphabetically by league as a tiebreaker
                return a.league.localeCompare(b.league);
            });
            // --- END: Sorting Logic for Status ---


            container.innerHTML = filteredGames.map(game => {
                // Check if the game ID exists as a key in the followedGames object
                const isFollowed = !!followedGames[game.id]; 
                return renderGameCardFeed(game, isFollowed); 
            }).join('');

            // Attach event listeners for follow/unfollow buttons
            document.querySelectorAll('.follow-btn').forEach(button => {
                button.removeEventListener('click', handleFollowToggle); // Remove existing
                button.addEventListener('click', handleFollowToggle); // Add fresh
            });
            // Attach event listeners for detail links
            document.querySelectorAll('.detail-link').forEach(link => {
                link.removeEventListener('click', (e) => { // Remove existing
                    e.preventDefault();
                    showGameDetail(e.target.dataset.gameId);
                });
                link.addEventListener('click', (e) => { // Add fresh
                    e.preventDefault();
                    showGameDetail(e.target.dataset.gameId);
                });
            });
        }
        
        /**
         * Handler for clicking on the main body of a followed game card to show details.
         */
        function handleDashboardDetailClick(e) {
            // e.currentTarget is the element the listener was attached to (the dashboard-detail-link div)
            const gameId = e.currentTarget.dataset.gameId;
            showGameDetail(gameId);
        }


        function renderFollowedGames() {
             // Only render if Firestore is ready
            if (!isAuthReady) return; 

            const container = document.getElementById('followed-games-container');
            const noGamesMessage = document.getElementById('no-followed-games');

            // 1. Render Friend Activity Feed (Mock)
            renderFriendActivityFeed(); 

            // 2. Render Followed Games: Filter gamesData using the keys from the followedGames object
            const followedList = gamesData.filter(game => followedGames[game.id]);

            if (followedList.length === 0) {
                noGamesMessage.classList.remove('hidden');
                container.innerHTML = '';
            } else {
                noGamesMessage.classList.add('hidden');
                container.innerHTML = followedList.map(game => renderFollowedGameCardDashboard(game)).join('');
                
                // Attach event listeners for unfollow buttons on the dashboard
                document.querySelectorAll('#followed-games-container .follow-btn').forEach(button => {
                    button.removeEventListener('click', handleFollowToggle); // Remove existing
                    button.addEventListener('click', handleFollowToggle); // Add fresh
                });
                
                // Attach event listeners for the clickable detail area on the dashboard (New)
                document.querySelectorAll('.dashboard-detail-link').forEach(link => {
                    // Remove existing listeners first
                    link.removeEventListener('click', handleDashboardDetailClick); 
                    // Add the new listener
                    link.addEventListener('click', handleDashboardDetailClick);
                });
            }
        }
        
        // NEW: Handles the display and real-time updates for prompts in the Admin Panel
        function renderAdminPrompts() {
            if (unsubscribePromptsAdmin) {
                unsubscribePromptsAdmin();
            }

            const promptsColRef = getGamePromptsColRef(db);
            // Query for all prompts (no filtering)
            const q = query(promptsColRef);
            
            unsubscribePromptsAdmin = onSnapshot(q, (snapshot) => {
                const prompts = [];
                snapshot.forEach(doc => {
                    prompts.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort in memory by creation date (newest first)
                prompts.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                const limitedPrompts = prompts.slice(0, 20); // Limit to last 20 for performance/clarity

                const tbody = document.getElementById('admin-prompt-list');
                const noPromptsMessage = document.getElementById('no-prompts-message');
                tbody.innerHTML = ''; // Clear previous content

                if (limitedPrompts.length === 0) {
                    noPromptsMessage.classList.remove('hidden');
                } else {
                    noPromptsMessage.classList.add('hidden');
                }

                limitedPrompts.forEach(p => {
                    const row = tbody.insertRow();
                    row.className = `transition duration-150 ${p.isResolved ? 'bg-green-50' : 'bg-red-50 hover:bg-red-100'}`;

                    // Game ID
                    row.insertCell().textContent = p.gameId;
                    
                    // Question (Truncated)
                    row.insertCell().textContent = p.question.substring(0, 50) + (p.question.length > 50 ? '...' : '');

                    // Status
                    const statusCell = row.insertCell();
                    statusCell.className = `font-bold ${p.isResolved ? 'text-green-700' : 'text-red-700'}`;
                    statusCell.textContent = p.isResolved ? 'Resolved' : 'Active';

                    // Answer
                    row.insertCell().textContent = p.isResolved ? p.answer : 'N/A';

                    // Actions
                    const actionCell = row.insertCell();
                    if (!p.isResolved) {
                        actionCell.innerHTML = `
                            <button data-id="${p.id}" data-answer="Yes" class="resolve-btn bg-green-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-green-600 transition duration-150 mr-2">
                                Resolve Yes
                            </button>
                            <button data-id="${p.id}" data-answer="No" class="resolve-btn bg-red-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-red-600 transition duration-150">
                                Resolve No
                            </button>
                        `;
                    } else {
                        actionCell.textContent = 'Actioned';
                    }
                });

                // Attach event listeners for resolution buttons
                document.querySelectorAll('.resolve-btn').forEach(button => {
                    button.onclick = (e) => {
                        const id = e.target.dataset.id;
                        const answer = e.target.dataset.answer;
                        handleSetAnswer(id, answer);
                    };
                });
            }, (error) => {
                console.error("Firestore onSnapshot (Admin Prompts) error:", error);
            });
        }


        function renderAdminPanel() {
             // Only render if Firestore is ready
            if (!isAuthReady) return; 

            // NEW: Render the prompt list (Active and Resolved)
            renderAdminPrompts(); 

            const tbody = document.getElementById('admin-game-list');
            tbody.innerHTML = ''; // Clear previous content

            gamesData.forEach(game => {
                const row = tbody.insertRow();
                row.className = 'hover:bg-gray-50 transition duration-150';

                // ID
                row.insertCell().textContent = game.id;
                // League
                row.insertCell().textContent = game.league;
                // Teams
                row.insertCell().textContent = `${game.awayTeam} vs ${game.homeTeam}`;
                // Status
                row.insertCell().textContent = game.status;
                // Time
                row.insertCell().textContent = game.time;

                // Score H/A - Now read-only inputs
                const scoreCell = row.insertCell();
                scoreCell.className = 'flex space-x-2 p-3';
                scoreCell.innerHTML = `
                    <input type="number" class="admin-input bg-gray-100 cursor-not-allowed" value="${game.homeScore}" readonly title="API data is read-only">
                    <input type="number" class="admin-input bg-gray-100 cursor-not-allowed" value="${game.awayScore}" readonly title="API data is read-only">
                `;

                // Actions (The save button is now just illustrative/non-functional)
                const actionCell = row.insertCell();
                actionCell.innerHTML = `
                    <button class="bg-gray-500 text-white px-3 py-1 rounded-lg text-sm opacity-50 cursor-not-allowed" disabled>
                        Save
                    </button>
                `;
            });
        }
        
        /**
         * NEW: Handles creating a new prompt and checking for active prompts.
         */
        async function handleNewPrompt() {
            if (!isAuthReady) {
                showMessageBox("Error", "Authentication not ready.");
                return;
            }

            const gameId = document.getElementById('prompt-game-id').value.trim();
            const question = document.getElementById('prompt-question').value.trim();

            if (!gameId || !question) {
                showMessageBox("Input Required", "Please enter both a valid Game ID and a Question.");
                return;
            }

            const promptsColRef = getGamePromptsColRef(db);

            // 1. Check for an existing active prompt for this game.
            const activeQuery = query(promptsColRef, where('gameId', '==', gameId), where('isResolved', '==', false));
            
            try {
                const activeSnapshot = await getDocs(activeQuery);
                
                if (!activeSnapshot.empty) {
                    showMessageBox("Existing Prompt Active", `There is already an active prompt for game ${gameId}. Please resolve the current one before creating a new one.`);
                    return;
                }

                // 2. Create the new prompt
                const newPrompt = {
                    gameId: gameId,
                    question: question,
                    createdAt: new Date().toISOString(),
                    userId: userId,
                    isResolved: false,
                    answer: null,
                    resolvedAt: null
                };

                await addDoc(promptsColRef, newPrompt);

                // Clear the message input after successful creation
                document.getElementById('prompt-question').value = '';
                showMessageBox("Prompt Created", `New live question successfully created for game ${gameId}!`);

            } catch (error) {
                console.error("Error sending new prompt:", error);
                showMessageBox("Prompt Error", `Failed to create prompt. Error: ${error.message}`);
            }
        }
        
        /**
         * NEW: Handles setting the answer and resolving the prompt.
         */
        async function handleSetAnswer(promptId, answer) {
            if (!isAuthReady) {
                showMessageBox("Error", "Authentication not ready.");
                return;
            }
            
            const promptDocRef = doc(getGamePromptsColRef(db), promptId);

            try {
                await updateDoc(promptDocRef, {
                    isResolved: true,
                    answer: answer,
                    resolvedAt: new Date().toISOString()
                });

                showMessageBox("Prompt Resolved", `The prompt has been resolved with answer: ${answer}. It will now expire for viewers and display the result.`);

            } catch (error) {
                console.error(`Error resolving prompt ${promptId}:`, error);
                showMessageBox("Resolution Error", `Failed to resolve prompt. Error: ${error.message}`);
            }
        }


        // --- Filter and UI Helper Functions ---

        function populateLeagueFilter() {
            const filter = document.getElementById('league-filter');
            const uniqueLeagues = ['All', ...new Set(Object.keys(ESPN_ENDPOINTS))];
            
            if (filter.options.length === 0 || filter.options.length !== uniqueLeagues.length) {
                filter.innerHTML = uniqueLeagues.map(league => 
                    `<option value="${league}">${league}</option>`
                ).join('');
            }

            // Remove and re-add listeners to prevent duplication
            filter.removeEventListener('change', renderScores);
            filter.addEventListener('change', renderScores);
            document.getElementById('status-filter').removeEventListener('change', renderScores);
            document.getElementById('status-filter').addEventListener('change', renderScores);
            
            const searchInput = document.getElementById('team-search');
            if (searchInput) {
                 searchInput.removeEventListener('input', renderScores);
                 searchInput.addEventListener('input', renderScores);
            }
        }

        function showGameDetail(gameId) {
            const game = gamesData.find(g => g.id === gameId);
            if (!game) {
                showMessageBox("Game Not Found", "The requested game detail could not be loaded.");
                return;
            }

            switchView('detail');

            const detailContent = document.getElementById('detail-content');
            
            // 1. Inject the structure into the DOM (Updated for prompts)
            detailContent.innerHTML = `
                <div class="flex flex-col items-center text-center">
                    <span class="text-sm font-semibold text-red-500 bg-red-100 px-3 py-1 rounded-full mb-4">${game.league}</span>
                    <h3 class="text-5xl font-black text-gray-900 mb-8">
                        ${game.awayTeam} <span class="text-gray-400 font-normal mx-4">@</span> ${game.homeTeam}
                    </h3>
                    
                    <!-- Scoreboard -->
                    <div class="flex space-x-8 items-center bg-gray-50 p-6 rounded-xl shadow-inner w-full max-w-lg">
                        <div class="flex-1">
                            <p class="text-xl font-semibold text-gray-600">${game.awayTeam}</p>
                            <p class="text-6xl font-extrabold text-gray-900">${game.awayScore}</p>
                        </div>
                        <div class="text-center">
                            <p class="text-lg font-bold ${game.status === 'In Progress' ? 'text-green-600' : 'text-gray-500'}">
                                ${game.time}
                            </p>
                            <p class="text-xs text-gray-500">${game.statusDetail}</p>
                        </div>
                        <div class="flex-1">
                            <p class="text-xl font-semibold text-gray-600">${game.homeTeam}</p>
                            <p class="text-6xl font-extrabold text-gray-900">${game.homeScore}</p>
                        </div>
                    </div>
                    
                    <!-- NEW LIVE PROMPT CONTAINER -->
                    <div id="live-prompt-container" class="mt-6 p-4 border-l-4 rounded-lg shadow-inner w-full max-w-lg transition duration-300 bg-gray-50 border-gray-300">
                        <p class="text-sm font-semibold mb-1 text-gray-700">LIVE YES/NO PROMPT:</p>
                        <p id="prompt-text" class="text-xl font-black text-gray-900">Waiting for a live question...</p>
                        
                        <!-- Resolution/Answer Box -->
                        <div id="prompt-answer-box" class="mt-4 pt-3 border-t border-gray-200 hidden">
                            <p class="text-sm font-medium text-gray-500 mb-2">RESULT:</p>
                            <!-- Answer will be styled here -->
                            <span id="prompt-answer-result" class="text-3xl font-extrabold px-4 py-2 rounded-full"></span>
                            <p id="prompt-resolved-user" class="text-xs text-gray-400 mt-2"></p>
                        </div>
                    </div>

                    <h4 class="text-2xl font-bold mt-8 text-gray-700">Live Play-by-Play & Chat (Mock)</h4>
                    <p class="text-gray-500 mt-2">
                        Game data is live! The full play-by-play and chat features would integrate here.
                    </p>
                </div>
            `;
            
            // 2. Clean up old listener if one exists
            if (unsubscribePromptListener) {
                unsubscribePromptListener();
                unsubscribePromptListener = null;
            }

            // 3. Set up new prompt listener
            const promptsColRef = getGamePromptsColRef(db);
            const q = query(promptsColRef, where('gameId', '==', gameId));

            unsubscribePromptListener = onSnapshot(q, (snapshot) => {
                const allPrompts = [];
                snapshot.forEach(doc => {
                    allPrompts.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort by creation date (newest first)
                allPrompts.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                const activePrompt = allPrompts.find(p => p.isResolved === false);
                const latestResolvedPrompt = allPrompts.find(p => p.isResolved === true);
                
                let promptToDisplay = activePrompt || latestResolvedPrompt;

                const container = document.getElementById('live-prompt-container');
                const textEl = document.getElementById('prompt-text');
                const answerBox = document.getElementById('prompt-answer-box');
                const answerResult = document.getElementById('prompt-answer-result');
                const resolvedUser = document.getElementById('prompt-resolved-user');

                // Reset display
                answerBox.classList.add('hidden');
                container.classList.remove('bg-red-50', 'border-red-500', 'bg-green-50', 'border-green-500');
                container.classList.add('bg-gray-50', 'border-gray-300'); // Default waiting state

                if (promptToDisplay) {
                    textEl.textContent = promptToDisplay.question;
                    
                    if (promptToDisplay.isResolved) {
                        // Display the resolved answer
                        answerBox.classList.remove('hidden');
                        answerResult.textContent = promptToDisplay.answer;
                        
                        const answerColor = promptToDisplay.answer === 'Yes' ? 'bg-green-600' : 'bg-red-600';
                        answerResult.className = `text-white ${answerColor} text-3xl font-extrabold px-4 py-2 rounded-lg inline-block shadow-md`;

                        const time = new Date(promptToDisplay.resolvedAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                        resolvedUser.textContent = `Resolved to ${promptToDisplay.answer} by Admin at ${time}`;

                        // Set container style for resolved state
                        container.classList.remove('bg-gray-50', 'border-gray-300');
                        container.classList.add('bg-green-50', 'border-green-500');

                    } else {
                        // Display active prompt (waiting for resolution)
                        container.classList.remove('bg-gray-50', 'border-gray-300');
                        container.classList.add('bg-red-50', 'border-red-500');
                    }

                } else {
                    textEl.textContent = "Waiting for a live question...";
                }
            }, (error) => {
                console.error("Prompt listener error:", error);
            });
        }
        
        /**
         * Writes to Firestore to update the user's followed games list (private)
         * AND updates the public follower count (game metadata).
         */
        async function handleFollowToggle(e) {
            if (!userId) {
                showMessageBox("Authentication Error", "Please wait for user authentication to complete before following games.");
                return;
            }

            const button = e.target;
            const gameId = button.dataset.gameId;
            const action = button.dataset.action;
            
            // 1. Prepare for private user document update
            const userDocRef = getFollowedGamesDocRef(db, userId);
            const newFollowedGames = { ...followedGames };

            // 2. Prepare for public follower count update
            const metadataColRef = getGameMetadataColRef(db);
            const gameMetadataDocRef = doc(metadataColRef, gameId);
            
            const batch = writeBatch(db);
            let updateSuccess = false;

            if (action === 'follow') {
                if (!followedGames[gameId]) {
                    newFollowedGames[gameId] = true;
                    // Batch: Update user document (private)
                    // We use set with the full map to overwrite the 'following' field
                    batch.set(userDocRef, { following: newFollowedGames });
                    // Batch: Increment public follower count (public)
                    batch.set(gameMetadataDocRef, { followerCount: increment(1) }, { merge: true });
                    updateSuccess = true;
                }
            } else if (action === 'unfollow') {
                if (followedGames[gameId]) {
                    delete newFollowedGames[gameId];
                    // Batch: Update user document (private)
                    batch.set(userDocRef, { following: newFollowedGames });
                    // Batch: Decrement public follower count (public)
                    batch.set(gameMetadataDocRef, { followerCount: increment(-1) }, { merge: true });
                    updateSuccess = true;
                }
            }
            
            if (updateSuccess) {
                try {
                    // Commit both private (user follow list) and public (follower count) changes atomically
                    await batch.commit();
                    // NOTE: The UI update is handled automatically by the two onSnapshot listeners
                    
                } catch (error) {
                    console.error("Error committing batch update for follow toggle: ", error);
                    showMessageBox("Save Error", `Failed to update follow status and public counter. Error: ${error.message}`);
                }
            }
        }

        // --- View Switching and Initialization ---

        function switchView(view) {
            // Hide all main views
            document.getElementById('dashboard-view').classList.add('hidden');
            document.getElementById('scores-view').classList.add('hidden');
            document.getElementById('admin-view').classList.add('hidden');
            document.getElementById('detail-view').classList.add('hidden');
            
            // Cleanup: Stop the prompt listener if moving away from the detail view
            if (unsubscribePromptListener) {
                unsubscribePromptListener();
                unsubscribePromptListener = null;
                console.log("Stopped game prompt listener.");
            }
            
            // Cleanup: Stop the admin prompt listener if moving away from the admin view
            if (view !== 'admin' && unsubscribePromptsAdmin) {
                 unsubscribePromptsAdmin();
                 unsubscribePromptsAdmin = null;
                 console.log("Stopped admin prompt listener.");
            }


            const linkIds = ['dashboard-link', 'scores-link', 'admin-link', 'dashboard-link-mobile', 'scores-link-mobile', 'admin-link-mobile'];
            
            // Determine the view that should be highlighted in the navigation
            let highlightedView = view;
            if (view === 'detail') {
                 // Detail is not a main nav item, so we don't highlight anything, or we could highlight 'scores' 
                 // as the general scores/game content area. Let's choose not to highlight for simplicity.
                 highlightedView = ''; 
                 document.getElementById('detail-view').classList.remove('hidden');
            } else if (view === 'dashboard') {
                document.getElementById('dashboard-view').classList.remove('hidden');
                renderFollowedGames();
            } else if (view === 'scores') {
                document.getElementById('scores-view').classList.remove('hidden');
                populateLeagueFilter(); 
                renderScores();
            } else if (view === 'admin') {
                document.getElementById('admin-view').classList.remove('hidden');
                // The renderAdminPanel function will now call renderAdminPrompts()
                renderAdminPanel();
            }


            // 1. Reset all link highlights
            linkIds.forEach(id => {
                const link = document.getElementById(id);
                if (link) {
                    link.classList.remove('text-red-400', 'bg-gray-700');
                    link.classList.add('text-white');
                }
            });

            // 2. Highlight active links
            if (highlightedView) {
                const desktopLink = document.getElementById(`${highlightedView}-link`);
                const mobileLink = document.getElementById(`${highlightedView}-link-mobile`);

                if (desktopLink) {
                    desktopLink.classList.remove('text-white');
                    desktopLink.classList.add('text-red-400');
                }
                if (mobileLink) {
                    mobileLink.classList.remove('text-white');
                    mobileLink.classList.add('text-red-400', 'bg-gray-700');
                }
            }
        }

        /**
         * Initializes Firebase, signs in, and sets up the Firestore listener.
         */
        async function initFirebaseAndLoadData() {
            try {
                // Check if the config is valid before calling initializeApp
                if (!resolvedFirebaseConfig.projectId || resolvedFirebaseConfig.projectId.includes("YOUR_PROJECT_ID")) {
                    showMessageBox("Configuration Error", "Firebase failed to initialize. Please update the 'USER_FIREBASE_CONFIG' object in the script with your actual project keys.");
                    return;
                }

                app = initializeApp(resolvedFirebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // 1. Handle Authentication via state listener
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        
                        // 2. Start Firestore Real-Time Listener for PRIVATE Followed Games
                        // This listener is crucial and needs to be inside the auth block.
                        const userDocRef = getFollowedGamesDocRef(db, userId);

                        if (userDocRef) {
                            onSnapshot(userDocRef, (docSnap) => {
                                if (docSnap.exists() && docSnap.data().following) {
                                    followedGames = docSnap.data().following;
                                    console.log("Followed games updated from private Firestore:", followedGames);
                                } else {
                                    followedGames = {}; 
                                    console.log("No private followed games found, initialized to empty.");
                                }
                                
                                // Re-render the UI views affected by followedGames change
                                renderFollowedGames();
                                if (!document.getElementById('scores-view').classList.contains('hidden')) {
                                    renderScores();
                                }
                            }, (error) => {
                                console.error("Firestore onSnapshot (Private) error:", error);
                                showMessageBox("Data Sync Error", "Failed to sync followed games data from the server.");
                            });
                        }
                        
                        // 3. Start Firestore Real-Time Listener for PUBLIC Game Metadata (Follower Count)
                        const metadataColRef = getGameMetadataColRef(db);
                        onSnapshot(metadataColRef, (snapshot) => {
                            const newMetadata = {};
                            snapshot.forEach(doc => {
                                const data = doc.data();
                                // Ensure followerCount is at least 0
                                newMetadata[doc.id] = { followerCount: Math.max(0, data.followerCount || 0) };
                            });
                            gameMetadata = newMetadata;
                            console.log("Game metadata (follower counts) updated from public Firestore:", gameMetadata);

                            // Re-render the UI views affected by public follower count change
                            if (!document.getElementById('scores-view').classList.contains('hidden')) {
                                renderScores();
                            }
                            if (!document.getElementById('dashboard-view').classList.contains('hidden')) {
                                renderFollowedGames();
                            }

                        }, (error) => {
                             // This error is the one you were seeing!
                             console.error("Firestore onSnapshot (Public) error:", error);
                             showMessageBox("Data Sync Error", "Failed to sync public follower count data from the server. Check security rules and network connection.");
                        });


                        // 4. Start fetching ESPN scores after auth is ready
                        fetchEspnScores();
                        // Set up interval for automatic score refreshing (e.g., every 30 seconds)
                        setInterval(fetchEspnScores, 30000); 

                        // 5. Initialize the main view
                        switchView('dashboard');
                        
                        // 6. Set up Admin Panel listener for new prompt creation
                        document.getElementById('prompt-send-btn').addEventListener('click', handleNewPrompt);


                    } else {
                        // Attempt sign-in using the provided custom token, or anonymously
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                // IMPORTANT: This only works if ANONYMOUS sign-in is enabled in your Firebase project!
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Firebase authentication error:", error);
                            isAuthReady = false;
                            userId = null;
                            showMessageBox("Authentication Failed", `Could not sign you in. Error: ${error.message}`);
                        }
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                showMessageBox("Initialization Failed", `Could not connect to the cloud service. Error: ${error.message}`);
            }
        }

        // --- Event Listeners and Initial Load ---
        
        // Mobile menu toggle listener
        document.getElementById('mobile-menu-button').addEventListener('click', () => {
            document.getElementById('mobile-menu').classList.toggle('hidden');
        });

        // Combined logic for all navigation links (Desktop and Mobile)
        const allNavLinks = [
            { id: 'admin-link', view: 'admin' },
            { id: 'dashboard-link', view: 'dashboard' },
            { id: 'scores-link', view: 'scores' },
            // ADDED: Mobile links for unified handling
            { id: 'admin-link-mobile', view: 'admin' },
            { id: 'dashboard-link-mobile', view: 'dashboard' },
            { id: 'scores-link-mobile', view: 'scores' }
        ];

        allNavLinks.forEach(item => {
            const link = document.getElementById(item.id);
            if (link) {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    // Logic to hide the mobile menu if a mobile link was clicked
                    if (item.id.includes('-mobile')) {
                        document.getElementById('mobile-menu').classList.add('hidden');
                    }
                    
                    switchView(item.view);
                });
            }
        });
        
        // Listener for Back button on Detail View
        document.getElementById('back-to-scores').addEventListener('click', (e) => {
            e.preventDefault();
            switchView('scores');
        });

        // Initialize the view and start fetching data when the window loads
        window.onload = initFirebaseAndLoadData;
    </script>
</body>
</html>
